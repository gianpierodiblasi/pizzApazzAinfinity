window.onload=t=>{switch(localStorage.getItem("z4language")){case"en":Translations.setEnglish(),Z4Translations.setEnglish();break;case"it":Translations.setItalian(),Z4Translations.setItalian()}switch(localStorage.getItem("z4theme")){case"light":break;case"dark":SwingJS.instance().darkMode(!0).build();break;default:SwingJS.instance().darkMode(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches).build()}let e=localStorage.getItem("z4color");e&&SwingJS.instance().mainActionBGColor(e).build(),new Z4Frame};class Z4Frame extends JSFrame{ribbon=new Z4Ribbon;canvas=new Z4Canvas;constructor(){super(),this.cssAddClass("z4frame"),this.getContentPane().setLayout(new BorderLayout(5,5)),this.ribbon.setCanvas(this.canvas),this.getContentPane().add(this.ribbon,BorderLayout.NORTH),this.getContentPane().add(this.canvas,BorderLayout.CENTER)}}class Z4RibbonFilePanel extends JSPanel{canvas=null;constructor(){super(),this.setLayout(new GridBagLayout),this.cssAddClass("z4ribbonfilepanel"),this.addLabel(Z4Translations.NEW,0),this.addButton(Z4Translations.CREATE,!0,0,1,"left",null),this.addButton(Z4Translations.FROM_CLIPBOARD,"function"==typeof navigator.clipboard.read,1,1,"both",t=>this.createFromClipboard()),this.addButton(Z4Translations.FROM_FILE,!0,2,1,"right",t=>this.createFromFile()),this.addVLine(3,0),this.addLabel(Z4Translations.OPEN,4),this.addButton(Z4Translations.OPEN_PROJECT,!0,4,1,"",null),this.addVLine(5,0),this.addLabel(Z4Translations.SAVE,6),this.addButton(Z4Translations.SAVE_PROJECT,!0,6,1,"left",null),this.addButton(Z4Translations.EXPORT,!0,7,1,"right",t=>this.exportToFile()),this.addVLine(8,1)}setCanvas(t){this.canvas=t}addLabel(t,e){let a=new JSLabel;a.setText(t);let s=new GridBagConstraints;s.gridx=e,s.gridy=0,s.anchor=GridBagConstraints.WEST,s.insets=new Insets(5,5,2,0),this.add(a,s)}addButton(t,e,a,s,i,n){let r=new JSButton;r.setText(t),r.setEnabled(e),r.setContentAreaFilled(!1),r.addActionListener(n);let l=new GridBagConstraints;switch(l.gridx=a,l.gridy=s,i){case"left":l.insets=new Insets(0,5,0,0),r.getStyle().borderTopRightRadius="0px",r.getStyle().borderBottomRightRadius="0px",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"both":r.getStyle().borderRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"right":l.insets=new Insets(0,0,0,5),r.getStyle().borderTopLeftRadius="0px",r.getStyle().borderBottomLeftRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)"}this.add(r,l)}addVLine(t,e){let a=new JSComponent(document.createElement("div"));a.getStyle().width="1px",a.getStyle().background="var(--main-action-bgcolor";let s=new GridBagConstraints;s.gridx=t,s.gridy=0,s.gridheight=2,s.fill=GridBagConstraints.VERTICAL,s.weightx=e,s.weighty=1,s.insets=new Insets(1,2,1,2),this.add(a,s)}createFromFile(){JSFileChooser.showOpenDialog(""+Z4Constants.ACCEPTED_IMAGE_FILE_FORMAT.join(","),JSFileChooser.SINGLE_SELECTION,0,t=>t.forEach(t=>this.canvas.createFromFile(t)))}createFromClipboard(){this.canvas.createFromClipboard()}exportToFile(){let t=new Z4ExportToFilePanel;t.setFilename(this.canvas.getProjectName()),JSOptionPane.showInputDialog(t,Z4Translations.EXPORT,e=>t.addChangeListener(e),()=>t.isValid(),e=>{e===JSOptionPane.OK_OPTION&&this.canvas.exportToFile(t.getFilename(),t.getFileExtension(),t.getQuality())})}}class Z4RibbonLayerPanel extends JSPanel{canvas=null;constructor(){super(),this.setLayout(new GridBagLayout),this.cssAddClass("z4ribbonlayerpanel"),this.addLabel(Z4Translations.NEW,0),this.addButton(Z4Translations.CREATE,!0,0,1,"left",null),this.addButton(Z4Translations.FROM_CLIPBOARD,"function"==typeof navigator.clipboard.read,1,1,"both",t=>this.addFromClipboard()),this.addButton(Z4Translations.FROM_FILE,!0,2,1,"right",t=>this.addFromFile()),this.addVLine(3,1)}setCanvas(t){this.canvas=t}addLabel(t,e){let a=new JSLabel;a.setText(t);let s=new GridBagConstraints;s.gridx=e,s.gridy=0,s.anchor=GridBagConstraints.WEST,s.insets=new Insets(5,5,2,0),this.add(a,s)}addButton(t,e,a,s,i,n){let r=new JSButton;r.setText(t),r.setEnabled(e),r.setContentAreaFilled(!1),r.addActionListener(n);let l=new GridBagConstraints;switch(l.gridx=a,l.gridy=s,i){case"left":l.insets=new Insets(0,5,0,0),r.getStyle().borderTopRightRadius="0px",r.getStyle().borderBottomRightRadius="0px",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"both":r.getStyle().borderRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"right":l.insets=new Insets(0,0,0,5),r.getStyle().borderTopLeftRadius="0px",r.getStyle().borderBottomLeftRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)"}this.add(r,l)}addVLine(t,e){let a=new JSComponent(document.createElement("div"));a.getStyle().width="1px",a.getStyle().background="var(--main-action-bgcolor";let s=new GridBagConstraints;s.gridx=t,s.gridy=0,s.gridheight=2,s.fill=GridBagConstraints.VERTICAL,s.weightx=e,s.weighty=1,s.insets=new Insets(1,2,1,2),this.add(a,s)}addFromFile(){JSFileChooser.showOpenDialog(""+Z4Constants.ACCEPTED_IMAGE_FILE_FORMAT.join(","),JSFileChooser.SINGLE_SELECTION,0,t=>t.forEach(t=>this.canvas.addLayerFromFile(t)))}addFromClipboard(){this.canvas.addLayerFromClipboard()}}class Z4RibbonSettingsPanel extends JSPanel{language=new JSComboBox;theme=new JSComboBox;color=new JSColorChooser;constructor(){super(),this.setLayout(new GridBagLayout),this.cssAddClass("z4ribbonsettingspanel");let t=new JSLabel;t.setText(Z4Translations.LANGUAGE);let e=new GridBagConstraints;e.gridx=0,e.gridy=0,e.anchor=GridBagConstraints.WEST,e.insets=new Insets(5,5,2,0),this.add(t,e);let a=new DefaultKeyValueComboBoxModelAndRenderer;a.addElement(new KeyValue("en",Z4Translations.LANGUAGE_ENGLISH_NATIVE)),a.addElement(new KeyValue("it",Z4Translations.LANGUAGE_ITALIAN_NATIVE)),this.language.setModelAndRenderer(a),this.language.setSelectedItem(Z4Translations.CURRENT_LANGUAGE),this.language.addActionListener(t=>this.onchangeLanguage()),(e=new GridBagConstraints).gridx=0,e.gridy=1,e.fill=GridBagConstraints.HORIZONTAL,e.insets=new Insets(0,5,0,5),this.add(this.language,e),(t=new JSLabel).setText(Z4Translations.THEME),(e=new GridBagConstraints).gridx=1,e.gridy=0,e.anchor=GridBagConstraints.WEST,e.insets=new Insets(5,5,2,0),this.add(t,e);let s=null;switch(localStorage.getItem("z4theme")){case"light":s=new KeyValue("light",Z4Translations.THEME_LIGHT);break;case"dark":s=new KeyValue("dark",Z4Translations.THEME_DARK);break;default:s=new KeyValue("auto",Z4Translations.THEME_AUTO)}let i=new DefaultKeyValueComboBoxModelAndRenderer;i.addElement(new KeyValue("auto",Z4Translations.THEME_AUTO)),i.addElement(new KeyValue("light",Z4Translations.THEME_LIGHT)),i.addElement(new KeyValue("dark",Z4Translations.THEME_DARK)),this.theme.setModelAndRenderer(i),this.theme.setSelectedItem(s),this.theme.addActionListener(t=>this.onchangeTheme()),(e=new GridBagConstraints).gridx=1,e.gridy=1,e.fill=GridBagConstraints.HORIZONTAL,e.insets=new Insets(0,5,0,5),this.add(this.theme,e),(t=new JSLabel).setText(Z4Translations.THEME_COLOR),(e=new GridBagConstraints).gridx=2,e.gridy=0,e.anchor=GridBagConstraints.WEST,e.insets=new Insets(5,5,2,0),this.add(t,e);let n=localStorage.getItem("z4color");this.color.setSelectedColor(Color.fromRGB_HEX(n||"#0d6efd")),this.color.setOpacityVisible(!1),this.color.addChangeListener(t=>this.onchangeColor()),(e=new GridBagConstraints).gridx=2,e.gridy=1,e.fill=GridBagConstraints.HORIZONTAL,e.insets=new Insets(0,5,0,5),this.add(this.color,e);let r=new JSButton;r.setText(Z4Translations.RESET),r.setContentAreaFilled(!1),r.addActionListener(t=>this.onreset()),(e=new GridBagConstraints).gridx=3,e.gridy=1,e.fill=GridBagConstraints.HORIZONTAL,e.insets=new Insets(0,5,0,5),this.add(r,e),t=new JSLabel,(e=new GridBagConstraints).gridx=4,e.gridy=0,e.fill=GridBagConstraints.BOTH,e.weightx=1,this.add(t,e)}onchangeLanguage(){localStorage.setItem("z4language",this.language.getSelectedItem().key),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.LANGUAGE,JSOptionPane.INFORMATION_MESSAGE,null)}onchangeTheme(){localStorage.setItem("z4theme",this.theme.getSelectedItem().key),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.THEME,JSOptionPane.INFORMATION_MESSAGE,null)}onchangeColor(){this.color.getValueIsAdjusting()||(localStorage.setItem("z4color",this.color.getSelectedColor().getRGB_HEX()),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.THEME_COLOR,JSOptionPane.INFORMATION_MESSAGE,null))}onreset(){localStorage.removeItem("z4language"),localStorage.removeItem("z4theme"),localStorage.removeItem("z4color"),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.RESET,JSOptionPane.INFORMATION_MESSAGE,null)}}class Z4ExportToFilePanel extends JSPanel{filename=new JSTextField;png=new JSRadioButton;jpg=new JSRadioButton;qualitySlider=new JSSlider;qualitySpinner=new JSSpinner;listeners=[];constructor(){super(),this.cssAddClass("z4exporttofilepanel"),this.setLayout(new GridBagLayout),this.addLabel(Z4Translations.FILENAME,0,0),this.filename.addActionListener(t=>this.onchange());let t=new GridBagConstraints;t.gridx=0,t.gridy=1,t.gridwidth=2,t.fill=GridBagConstraints.HORIZONTAL,t.weightx=1,this.add(this.filename,t);let e=new ButtonGroup;e.add(this.png),e.add(this.jpg),this.addRadio(this.png,!0,"PNG",0),this.addRadio(this.jpg,!1,"JPG",1),this.addLabel(Z4Translations.QUALITY,0,3),this.qualitySlider.setEnabled(!1),this.qualitySlider.setValue(100),this.qualitySlider.addChangeListener(t=>this.qualitySpinner.setValue(this.qualitySlider.getValue())),(t=new GridBagConstraints).gridx=0,t.gridy=4,t.gridwidth=2,t.fill=GridBagConstraints.HORIZONTAL,t.weightx=1,this.add(this.qualitySlider,t),this.qualitySpinner.setEnabled(!1),this.qualitySpinner.setModel(new SpinnerNumberModel(100,0,100,1)),this.qualitySpinner.addChangeListener(t=>this.qualitySlider.setValue(this.qualitySpinner.getValue())),this.qualitySpinner.getStyle().minWidth="3rem",this.qualitySpinner.getChilStyleByQuery("input[type=number]").minWidth="2.5rem",this.qualitySpinner.getChilStyleByQuery("input[type=number]").width="2.5rem",(t=new GridBagConstraints).gridx=1,t.gridy=3,t.anchor=GridBagConstraints.EAST,this.add(this.qualitySpinner,t)}addLabel(t,e,a){let s=new JSLabel;s.setText(t);let i=new GridBagConstraints;i.gridx=e,i.gridy=a,i.anchor=GridBagConstraints.WEST,this.add(s,i)}onchange(){let t=new ChangeEvent;this.listeners.forEach(e=>{"function"==typeof e?e(t):e.stateChanged(t)})}addRadio(t,e,a,s){t.setSelected(e),t.setText(a),t.addActionListener(t=>{this.qualitySlider.setEnabled(!e),this.qualitySpinner.setEnabled(!e)});let i=new GridBagConstraints;i.gridx=s,i.gridy=2,i.anchor=GridBagConstraints.WEST,this.add(t,i)}addChangeListener(t){this.listeners.push(t)}isValid(){return!!this.filename.getText()}setFilename(t){this.filename.setText(t)}getFilename(){return this.filename.getText()}getFileExtension(){return this.png.isSelected()?".png":".jpg"}getQuality(){return this.qualitySpinner.getValue()/100}}class Z4Ribbon extends JSTabbedPane{filePanel=new Z4RibbonFilePanel;layerPanel=new Z4RibbonLayerPanel;settingsPanel=new Z4RibbonSettingsPanel;constructor(){super(),this.cssAddClass("z4ribbon"),this.addTab(Z4Translations.FILE,this.filePanel),this.addTab(Z4Translations.LAYER,this.layerPanel),this.addTab(Z4Translations.SETTINGS,this.settingsPanel)}setCanvas(t){this.filePanel.setCanvas(t),this.layerPanel.setCanvas(t)}}class Z4Canvas extends JSComponent{canvas=document.createElement("canvas");ctx=this.canvas.getContext("2d");chessboard=null;resizeObserver=new ResizeObserver(()=>this.drawCanvas());projectName=null;paper=new Z4Paper;static WIDTH=500;static HEIGHT=500;constructor(){super(document.createElement("div")),this.cssAddClass("z4canvas"),this.resizeObserver.observe(this.canvas),this.canvas.width=Z4Canvas.WIDTH,this.canvas.height=Z4Canvas.HEIGHT,this.appendNodeChild(this.canvas),this.addLayer(Z4Canvas.WIDTH,Z4Canvas.HEIGHT);let t=document.createElement("img");t.onload=e=>(this.chessboard=this.ctx.createPattern(t,"repeat"),this.drawCanvas(),null),t.src="image/chessboard.png"}createFromFile(t){let e=new FileReader;e.onload=a=>this.createFromURL(t.name.substring(0,t.name.lastIndexOf(".")),e.result),e.readAsDataURL(t)}createFromClipboard(){navigator.clipboard.read().then(t=>{t.forEach(t=>{let e=t.types.find((t,e,a)=>t.startsWith("image/"));t.getType(e).then(t=>{this.createFromURL("",URL.createObjectURL(t))})})})}createFromURL(t,e){let a=document.createElement("img");return a.onload=e=>(this.paper.reset(),this.paper.addLayerFromImage(a,a.width,a.height),this.afterCreate(t,a.width,a.height),this.drawCanvas(),null),a.src=e,null}afterCreate(t,e,a){this.projectName=t,this.canvas.width=e,this.canvas.height=a}exportToFile(t,e,a){let s=new OffscreenCanvas(this.canvas.width,this.canvas.height),i=s.getContext("2d");this.paper.draw(i);let n={};n.type=".png"===e?"image/png":"image/jpeg",n.quality=a,s.convertToBlob(n).then(a=>{let s=document.createElement("a");s.setAttribute("href",URL.createObjectURL(a)),s.setAttribute("download",t+e),document.body.appendChild(s);let i=document.createEvent("MouseEvents");i.initEvent("click",!1,!1),s.dispatchEvent(i),document.body.removeChild(s)})}addLayer(t,e){this.paper.addLayer(t,e,this.canvas.width,this.canvas.height),this.afterAddLayer(),this.drawCanvas()}addLayerFromFile(t){let e=new FileReader;e.onload=t=>this.addLayerFromURL(e.result),e.readAsDataURL(t)}addLayerFromClipboard(){navigator.clipboard.read().then(t=>{t.forEach(t=>{let e=t.types.find((t,e,a)=>t.startsWith("image/"));t.getType(e).then(t=>{this.addLayerFromURL(URL.createObjectURL(t))})})})}addLayerFromURL(t){let e=document.createElement("img");return e.onload=t=>(this.paper.addLayerFromImage(e,this.canvas.width,this.canvas.height),this.afterAddLayer(),this.drawCanvas(),null),e.src=t,null}afterAddLayer(){let t=this.paper.getSize(),e=(t.width-this.canvas.width)/2,a=(t.height-this.canvas.height)/2;this.paper.shift(e,a),this.canvas.width=t.width,this.canvas.height=t.height}getProjectName(){return this.projectName}drawCanvas(){this.ctx.save(),this.ctx.fillStyle=this.chessboard,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.paper.draw(this.ctx)}}class Z4Translations{static CURRENT_LANGUAGE=null;static FILE="";static NEW="";static CREATE="";static FROM_CLIPBOARD="";static FROM_FILE="";static OPEN="";static OPEN_PROJECT="";static SAVE="";static SAVE_PROJECT="";static EXPORT="";static LAYER="";static SETTINGS="";static LANGUAGE="";static LANGUAGE_ENGLISH_NATIVE="";static LANGUAGE_ITALIAN_NATIVE="";static THEME="";static THEME_AUTO="";static THEME_LIGHT="";static THEME_DARK="";static THEME_COLOR="";static REFRESH_PAGE_MESSAGE="";static FILENAME="";static QUALITY="";static RESET="";static{switch(navigator.language.substring(0,2)){case"en":default:Z4Translations.setEnglish();break;case"it":Z4Translations.setItalian()}}constructor(){}static setEnglish(){Z4Translations.FILE="File",Z4Translations.NEW="New",Z4Translations.CREATE="Create",Z4Translations.FROM_CLIPBOARD="From Clipboard",Z4Translations.FROM_FILE="From File",Z4Translations.OPEN="Open",Z4Translations.OPEN_PROJECT="Open Project",Z4Translations.SAVE="Save",Z4Translations.SAVE_PROJECT="Save Project",Z4Translations.EXPORT="Export",Z4Translations.LAYER="Layer",Z4Translations.SETTINGS="Settings",Z4Translations.LANGUAGE="Language",Z4Translations.LANGUAGE_ENGLISH_NATIVE="English",Z4Translations.LANGUAGE_ITALIAN_NATIVE="Italiano",Z4Translations.THEME="Theme",Z4Translations.THEME_AUTO="Auto",Z4Translations.THEME_LIGHT="Light",Z4Translations.THEME_DARK="Dark",Z4Translations.THEME_COLOR="Color",Z4Translations.REFRESH_PAGE_MESSAGE="Refresh the page to make the changes",Z4Translations.FILENAME="File Name",Z4Translations.QUALITY="Quality",Z4Translations.RESET="Reset",Z4Translations.CURRENT_LANGUAGE=new KeyValue("en",Z4Translations.LANGUAGE_ENGLISH_NATIVE)}static setItalian(){Z4Translations.FILE="File",Z4Translations.NEW="Nuovo",Z4Translations.CREATE="Crea",Z4Translations.FROM_CLIPBOARD="Dagli Appunti",Z4Translations.FROM_FILE="Da File",Z4Translations.OPEN="Apri",Z4Translations.OPEN_PROJECT="Apri Progetto",Z4Translations.SAVE="Salva",Z4Translations.SAVE_PROJECT="Salva Progetto",Z4Translations.EXPORT="Esporta",Z4Translations.LAYER="Livello",Z4Translations.SETTINGS="Impostazioni",Z4Translations.LANGUAGE="Lingua",Z4Translations.LANGUAGE_ENGLISH_NATIVE="English",Z4Translations.LANGUAGE_ITALIAN_NATIVE="Italiano",Z4Translations.THEME="Tema",Z4Translations.THEME_AUTO="Auto",Z4Translations.THEME_LIGHT="Chiaro",Z4Translations.THEME_DARK="Scuro",Z4Translations.THEME_COLOR="Colore",Z4Translations.REFRESH_PAGE_MESSAGE="Aggiorna la pagina per eseguire le modifiche",Z4Translations.FILENAME="Nome File",Z4Translations.QUALITY="Qualit\xe0",Z4Translations.RESET="Ripristina",Z4Translations.CURRENT_LANGUAGE=new KeyValue("it",Z4Translations.LANGUAGE_ITALIAN_NATIVE)}}class Z4Constants{static ACCEPTED_IMAGE_FILE_FORMAT=[".gif",".png",".jpeg",".jpg"];constructor(){}}class Z4Layer{offscreen=null;offscreenCtx=null;offsetX=0;offsetY=0;width=0;height=0;constructor(t,e,a,s){this.offscreen=new OffscreenCanvas(t,e),this.offscreenCtx=this.offscreen.getContext("2d"),this.offsetX=(a-t)/2,this.offsetY=(s-e)/2,this.width=t,this.height=e}static fromImage(t,e,a){let s=new Z4Layer(t.width,t.height,e,a);return s.offscreenCtx.drawImage(t,0,0),s}shift(t,e){this.offsetX+=t,this.offsetY+=e}move(t,e){this.offsetX=t,this.offsetY=e}getSize(){return new Dimension(this.width,this.height)}draw(t){t.drawImage(this.offscreen,this.offsetX,this.offsetY)}}class Z4Paper{layers=[];getLayersCount(){return this.layers.length}getLayerAt(t){return this.layers[t]}addLayer(t,e,a,s){this.layers.push(new Z4Layer(t,e,a,s))}addLayerFromImage(t,e,a){this.layers.push(Z4Layer.fromImage(t,e,a))}reset(){this.layers.length=0}shift(t,e){this.layers.forEach(a=>a.shift(t,e))}getSize(){return this.layers.map(t=>t.getSize()).reduce((t,e,a,s)=>t?new Dimension(Math.max(t.width,e.width),Math.max(t.height,e.height)):e)}draw(t){this.layers.forEach(e=>e.draw(t))}}