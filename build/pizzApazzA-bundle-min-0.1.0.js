window.onload=e=>{switch(localStorage.getItem("z4language")){case"en":Translations.setEnglish(),Z4Translations.setEnglish();break;case"it":Translations.setItalian(),Z4Translations.setItalian()}switch(localStorage.getItem("z4theme")){case"light":break;case"dark":SwingJS.instance().darkMode(!0).build();break;default:SwingJS.instance().darkMode(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches).build()}let t=localStorage.getItem("z4color");t&&SwingJS.instance().mainActionBGColor(t).build(),new Z4Frame};class Z4ColorPreview extends JSComponent{component=new JSComponent(document.createElement("div"));componentOpacity=new JSComponent(document.createElement("div"));constructor(){super(document.createElement("div")),this.cssAddClass("z4colorpreview"),this.component.cssAddClass("z4colorpreview-opaque"),this.appendChild(this.component),this.componentOpacity.cssAddClass("z4colorpreview-transparent"),this.appendChild(this.componentOpacity),this.setColor(new Color(0,0,0,255))}setColor(e){this.component.getStyle().backgroundColor=e.getRGB_String(),this.componentOpacity.getStyle().backgroundColor=e.getRGBA_String();let t=[],s=[];t[0]=e.red,t[1]=e.green,t[2]=e.blue,Color.RGBtoHSL(t,s),this.getStyle().border="1px solid "+(s[2]>.5?e.darkened(.1).getRGB_HEX():e.lighted(.1).getRGB_HEX())}}class Z4Frame extends JSFrame{ribbon=new Z4Ribbon;canvas=new Z4Canvas;statusPanel=new Z4StatusPanel;constructor(){super(),this.cssAddClass("z4frame"),this.getContentPane().setLayout(new BorderLayout(5,5)),this.ribbon.setCanvas(this.canvas),this.ribbon.setStatusPanel(this.statusPanel),this.getContentPane().add(this.ribbon,BorderLayout.NORTH),this.getContentPane().add(this.canvas,BorderLayout.CENTER),this.getContentPane().add(this.statusPanel,BorderLayout.SOUTH)}}class Z4RibbonFilePanel extends JSPanel{canvas=null;statusPanel=null;constructor(){super(),this.setLayout(new GridBagLayout),this.cssAddClass("z4ribbonfilepanel"),this.addLabel(Z4Translations.NEW_PROJECT,0,3),this.addButton(Z4Translations.CREATE,!0,0,1,"left",e=>this.checkSaved(Z4Translations.CREATE,()=>this.createFromColor())),this.addButton(Z4Translations.FROM_CLIPBOARD,"function"==typeof navigator.clipboard.read,1,1,"both",e=>this.checkSaved(Z4Translations.FROM_CLIPBOARD,()=>this.createFromClipboard())),this.addButton(Z4Translations.FROM_FILE,!0,2,1,"right",e=>this.checkSaved(Z4Translations.FROM_FILE,()=>this.createFromFile())),this.addVLine(3,0),this.addLabel(Z4Translations.OPEN,4,1),this.addButton(Z4Translations.OPEN_PROJECT,!0,4,1,"",e=>this.checkSaved(Z4Translations.OPEN_PROJECT,()=>this.openProject())),this.addVLine(5,0),this.addLabel(Z4Translations.SAVE,6,2),this.addButton(Z4Translations.SAVE_PROJECT,!0,6,1,"left",e=>this.saveProject(null)),this.addButton(Z4Translations.EXPORT,!0,7,1,"right",e=>this.exportToFile()),this.addVLine(8,1)}setCanvas(e){this.canvas=e}setStatusPanel(e){this.statusPanel=e}addLabel(e,t,s){let a=new JSLabel;a.setText(e);let i=new GridBagConstraints;i.gridx=t,i.gridy=0,i.gridwidth=s,i.anchor=GridBagConstraints.WEST,i.insets=new Insets(5,5,2,0),this.add(a,i)}addButton(e,t,s,a,i,n){let r=new JSButton;r.setText(e),r.setEnabled(t),r.setContentAreaFilled(!1),r.addActionListener(n);let l=new GridBagConstraints;switch(l.gridx=s,l.gridy=a,i){case"left":l.insets=new Insets(0,5,0,0),r.getStyle().borderTopRightRadius="0px",r.getStyle().borderBottomRightRadius="0px",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"both":r.getStyle().borderRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"right":l.insets=new Insets(0,0,0,5),r.getStyle().borderTopLeftRadius="0px",r.getStyle().borderBottomLeftRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)"}this.add(r,l)}addVLine(e,t){let s=new JSComponent(document.createElement("div"));s.getStyle().width="1px",s.getStyle().background="var(--main-action-bgcolor";let a=new GridBagConstraints;a.gridx=e,a.gridy=0,a.gridheight=2,a.fill=GridBagConstraints.VERTICAL,a.weightx=t,a.weighty=1,a.insets=new Insets(1,2,1,2),this.add(s,a)}checkSaved(e,t){this.canvas.isSaved()?t():JSOptionPane.showConfirmDialog(Z4Translations.PROJECT_NOT_SAVED_MESSAGE,e,JSOptionPane.YES_NO_CANCEL_OPTION,JSOptionPane.QUESTION_MESSAGE,e=>{switch(e){case JSOptionPane.YES_OPTION:this.saveProject(t);break;case JSOptionPane.NO_OPTION:t()}})}createFromColor(){let e=new Z4NewImagePanel;JSOptionPane.showInputDialog(e,Z4Translations.CREATE,e=>{},()=>!0,t=>{if(t===JSOptionPane.OK_OPTION){let s=e.getSelectedSize();this.canvas.create(s.width,s.height,e.getSelectedColor(),this.statusPanel)}})}createFromFile(){JSFileChooser.showOpenDialog(""+Z4Constants.ACCEPTED_IMAGE_FILE_FORMAT.join(","),JSFileChooser.SINGLE_SELECTION,0,e=>e.forEach(e=>this.canvas.createFromFile(e,this.statusPanel)))}createFromClipboard(){this.canvas.createFromClipboard(this.statusPanel)}openProject(){JSFileChooser.showOpenDialog(".z4i",JSFileChooser.SINGLE_SELECTION,0,e=>e.forEach(e=>this.canvas.openProject(e,this.statusPanel)))}saveProject(e){let t=new JSPanel;t.setLayout(new BorderLayout(0,0));let s=new JSLabel;s.setText(Z4Translations.PROJECT_NAME),t.add(s,BorderLayout.NORTH);let a=new JSTextField;a.setText(this.canvas.getProjectName()),t.add(a,BorderLayout.CENTER),JSOptionPane.showInputDialog(t,Z4Translations.SAVE,e=>a.addActionListener(t=>e(new ChangeEvent)),()=>!!a.getText(),t=>{t===JSOptionPane.OK_OPTION&&this.canvas.saveProject(a.getText(),this.statusPanel,e)})}exportToFile(){let e=new Z4ExportToFilePanel;e.setFilename(this.canvas.getProjectName()),JSOptionPane.showInputDialog(e,Z4Translations.EXPORT,t=>e.addChangeListener(t),()=>e.isValid(),t=>{t===JSOptionPane.OK_OPTION&&this.canvas.exportToFile(e.getFilename(),e.getFileExtension(),e.getQuality())})}}class Z4RibbonLayerPanel extends JSPanel{canvas=null;constructor(){super(),this.setLayout(new GridBagLayout),this.cssAddClass("z4ribbonlayerpanel"),this.addLabel(Z4Translations.NEW_LAYER,0),this.addButton(Z4Translations.CREATE,!0,0,1,"left",e=>this.addFromColor()),this.addButton(Z4Translations.FROM_CLIPBOARD,"function"==typeof navigator.clipboard.read,1,1,"both",e=>this.addFromClipboard()),this.addButton(Z4Translations.FROM_FILE,!0,2,1,"right",e=>this.addFromFile()),this.addVLine(3,1)}setCanvas(e){this.canvas=e}addLabel(e,t){let s=new JSLabel;s.setText(e);let a=new GridBagConstraints;a.gridx=t,a.gridy=0,a.gridwidth=3,a.anchor=GridBagConstraints.WEST,a.insets=new Insets(5,5,2,0),this.add(s,a)}addButton(e,t,s,a,i,n){let r=new JSButton;r.setText(e),r.setEnabled(t),r.setContentAreaFilled(!1),r.addActionListener(n);let l=new GridBagConstraints;switch(l.gridx=s,l.gridy=a,i){case"left":l.insets=new Insets(0,5,0,0),r.getStyle().borderTopRightRadius="0px",r.getStyle().borderBottomRightRadius="0px",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"both":r.getStyle().borderRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)",r.getStyle().borderRight="1px solid var(--main-action-bgcolor)";break;case"right":l.insets=new Insets(0,0,0,5),r.getStyle().borderTopLeftRadius="0px",r.getStyle().borderBottomLeftRadius="0px",r.getStyle().borderLeft="1px solid var(--main-action-bgcolor)"}this.add(r,l)}addVLine(e,t){let s=new JSComponent(document.createElement("div"));s.getStyle().width="1px",s.getStyle().background="var(--main-action-bgcolor";let a=new GridBagConstraints;a.gridx=e,a.gridy=0,a.gridheight=2,a.fill=GridBagConstraints.VERTICAL,a.weightx=t,a.weighty=1,a.insets=new Insets(1,2,1,2),this.add(s,a)}addFromColor(){let e=new Z4NewImagePanel;JSOptionPane.showInputDialog(e,Z4Translations.CREATE,e=>{},()=>!0,t=>{if(t===JSOptionPane.OK_OPTION){let s=e.getSelectedSize();this.canvas.addLayer(s.width,s.height,e.getSelectedColor())}})}addFromFile(){JSFileChooser.showOpenDialog(""+Z4Constants.ACCEPTED_IMAGE_FILE_FORMAT.join(","),JSFileChooser.SINGLE_SELECTION,0,e=>e.forEach(e=>this.canvas.addLayerFromFile(e)))}addFromClipboard(){this.canvas.addLayerFromClipboard()}}class Z4RibbonSettingsPanel extends JSPanel{language=new JSComboBox;theme=new JSComboBox;color=new JSColorChooser;constructor(){super(),this.setLayout(new GridBagLayout),this.cssAddClass("z4ribbonsettingspanel");let e=new JSLabel;e.setText(Z4Translations.LANGUAGE);let t=new GridBagConstraints;t.gridx=0,t.gridy=0,t.anchor=GridBagConstraints.WEST,t.insets=new Insets(5,5,2,0),this.add(e,t);let s=new DefaultKeyValueComboBoxModelAndRenderer;s.addElement(new KeyValue("en",Z4Translations.LANGUAGE_ENGLISH_NATIVE)),s.addElement(new KeyValue("it",Z4Translations.LANGUAGE_ITALIAN_NATIVE)),this.language.setModelAndRenderer(s),this.language.setSelectedItem(Z4Translations.CURRENT_LANGUAGE),this.language.addActionListener(e=>this.onchangeLanguage()),(t=new GridBagConstraints).gridx=0,t.gridy=1,t.fill=GridBagConstraints.HORIZONTAL,t.insets=new Insets(0,5,0,5),this.add(this.language,t),(e=new JSLabel).setText(Z4Translations.THEME),(t=new GridBagConstraints).gridx=1,t.gridy=0,t.anchor=GridBagConstraints.WEST,t.insets=new Insets(5,5,2,0),this.add(e,t);let a=null;switch(localStorage.getItem("z4theme")){case"light":a=new KeyValue("light",Z4Translations.THEME_LIGHT);break;case"dark":a=new KeyValue("dark",Z4Translations.THEME_DARK);break;default:a=new KeyValue("auto",Z4Translations.THEME_AUTO)}let i=new DefaultKeyValueComboBoxModelAndRenderer;i.addElement(new KeyValue("auto",Z4Translations.THEME_AUTO)),i.addElement(new KeyValue("light",Z4Translations.THEME_LIGHT)),i.addElement(new KeyValue("dark",Z4Translations.THEME_DARK)),this.theme.setModelAndRenderer(i),this.theme.setSelectedItem(a),this.theme.addActionListener(e=>this.onchangeTheme()),(t=new GridBagConstraints).gridx=1,t.gridy=1,t.fill=GridBagConstraints.HORIZONTAL,t.insets=new Insets(0,5,0,5),this.add(this.theme,t),(e=new JSLabel).setText(Z4Translations.THEME_COLOR),(t=new GridBagConstraints).gridx=2,t.gridy=0,t.anchor=GridBagConstraints.WEST,t.insets=new Insets(5,5,2,0),this.add(e,t);let n=localStorage.getItem("z4color");this.color.setSelectedColor(Color.fromRGB_HEX(n||"#0d6efd")),this.color.setOpacityVisible(!1),this.color.addChangeListener(e=>this.onchangeColor()),(t=new GridBagConstraints).gridx=2,t.gridy=1,t.fill=GridBagConstraints.HORIZONTAL,t.insets=new Insets(0,5,0,5),this.add(this.color,t);let r=new JSButton;r.setText(Z4Translations.RESET),r.setContentAreaFilled(!1),r.addActionListener(e=>this.onreset()),(t=new GridBagConstraints).gridx=3,t.gridy=1,t.fill=GridBagConstraints.HORIZONTAL,t.insets=new Insets(0,5,0,5),this.add(r,t),e=new JSLabel,(t=new GridBagConstraints).gridx=4,t.gridy=0,t.fill=GridBagConstraints.BOTH,t.weightx=1,this.add(e,t)}onchangeLanguage(){localStorage.setItem("z4language",this.language.getSelectedItem().key),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.LANGUAGE,JSOptionPane.INFORMATION_MESSAGE,null)}onchangeTheme(){localStorage.setItem("z4theme",this.theme.getSelectedItem().key),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.THEME,JSOptionPane.INFORMATION_MESSAGE,null)}onchangeColor(){this.color.getValueIsAdjusting()||(localStorage.setItem("z4color",this.color.getSelectedColor().getRGB_HEX()),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.THEME_COLOR,JSOptionPane.INFORMATION_MESSAGE,null))}onreset(){localStorage.removeItem("z4language"),localStorage.removeItem("z4theme"),localStorage.removeItem("z4color"),JSOptionPane.showMessageDialog(Z4Translations.REFRESH_PAGE_MESSAGE,Z4Translations.RESET,JSOptionPane.INFORMATION_MESSAGE,null)}}class Z4ExportToFilePanel extends JSPanel{filename=new JSTextField;png=new JSRadioButton;jpg=new JSRadioButton;qualitySlider=new JSSlider;qualitySpinner=new JSSpinner;listeners=[];constructor(){super(),this.cssAddClass("z4exporttofilepanel"),this.setLayout(new GridBagLayout),this.addLabel(Z4Translations.FILENAME,0,0),this.filename.addActionListener(e=>this.onchange());let e=new GridBagConstraints;e.gridx=0,e.gridy=1,e.gridwidth=2,e.fill=GridBagConstraints.HORIZONTAL,e.weightx=1,this.add(this.filename,e);let t=new ButtonGroup;t.add(this.png),t.add(this.jpg),this.addRadio(this.png,!0,"PNG",0),this.addRadio(this.jpg,!1,"JPG",1),this.addLabel(Z4Translations.QUALITY,0,3),this.qualitySlider.setEnabled(!1),this.qualitySlider.setValue(100),this.qualitySlider.addChangeListener(e=>this.qualitySpinner.setValue(this.qualitySlider.getValue())),(e=new GridBagConstraints).gridx=0,e.gridy=4,e.gridwidth=2,e.fill=GridBagConstraints.HORIZONTAL,e.weightx=1,this.add(this.qualitySlider,e),this.qualitySpinner.setEnabled(!1),this.qualitySpinner.setModel(new SpinnerNumberModel(100,0,100,1)),this.qualitySpinner.addChangeListener(e=>this.qualitySlider.setValue(this.qualitySpinner.getValue())),this.qualitySpinner.getStyle().minWidth="3rem",this.qualitySpinner.getChilStyleByQuery("input[type=number]").minWidth="2.5rem",this.qualitySpinner.getChilStyleByQuery("input[type=number]").width="2.5rem",(e=new GridBagConstraints).gridx=1,e.gridy=3,e.anchor=GridBagConstraints.EAST,this.add(this.qualitySpinner,e)}addLabel(e,t,s){let a=new JSLabel;a.setText(e);let i=new GridBagConstraints;i.gridx=t,i.gridy=s,i.anchor=GridBagConstraints.WEST,this.add(a,i)}onchange(){let e=new ChangeEvent;this.listeners.forEach(t=>{"function"==typeof t?t(e):t.stateChanged(e)})}addRadio(e,t,s,a){e.setSelected(t),e.setText(s),e.addActionListener(e=>{this.qualitySlider.setEnabled(!t),this.qualitySpinner.setEnabled(!t)});let i=new GridBagConstraints;i.gridx=a,i.gridy=2,i.anchor=GridBagConstraints.WEST,this.add(e,i)}addChangeListener(e){this.listeners.push(e)}isValid(){return!!this.filename.getText()}setFilename(e){this.filename.setText(e)}getFilename(){return this.filename.getText()}getFileExtension(){return this.png.isSelected()?".png":".jpg"}getQuality(){return this.qualitySpinner.getValue()/100}}class Z4NewImagePanel extends JSPanel{width=new JSSpinner;height=new JSSpinner;resolution=new JSSpinner;dimensionMM=new JSLabel;dimensionIN=new JSLabel;colorPreview=new Z4ColorPreview;selectedColor=new Color(255,255,255,255);constructor(){super(),this.cssAddClass("z4newimagepanel"),this.setLayout(new GridBagLayout),this.addLabel(Z4Translations.WIDTH+" (px)",0,0,1,0),this.addSpinner(this.width,Z4Constants.DEFAULT_IMAGE_SIZE,Z4Constants.MAX_IMAGE_SIZE,0,1),this.addLabel(Z4Translations.HEIGHT+" (px)",1,0,1,0),this.addSpinner(this.height,Z4Constants.DEFAULT_IMAGE_SIZE,Z4Constants.MAX_IMAGE_SIZE,1,1),this.addLabel(Z4Translations.RESOLUTION+" (dpi)",2,0,1,0),this.addSpinner(this.resolution,Z4Constants.DEFAULT_DPI,Z4Constants.MAX_DPI,2,1),this.addDimension(this.dimensionMM,3),this.addDimension(this.dimensionIN,4),this.addLabel(Z4Translations.FILLING_COLOR,0,5,3,10),this.colorPreview.setColor(this.selectedColor);let e=new GridBagConstraints;e.gridx=0,e.gridy=6,e.gridwidth=2,e.fill=GridBagConstraints.HORIZONTAL,e.insets=new Insets(0,5,0,5),this.add(this.colorPreview,e);let t=new JSButton;t.setText(Z4Translations.EDIT),t.addActionListener(e=>{JSColorChooser.showDialog(Z4Translations.FILLING_COLOR,this.selectedColor,!0,null,e=>{this.selectedColor=e,this.colorPreview.setColor(e)})}),(e=new GridBagConstraints).gridx=2,e.gridy=6,e.gridwidth=1,e.anchor=GridBagConstraints.WEST,this.add(t,e),this.setDimensions()}addLabel(e,t,s,a,i){let n=new JSLabel;n.setText(e);let r=new GridBagConstraints;r.gridx=t,r.gridy=s,r.gridwidth=a,r.anchor=GridBagConstraints.WEST,r.insets=new Insets(i,5,0,5),this.add(n,r)}addSpinner(e,t,s,a,i){e.setModel(new SpinnerNumberModel(t,1,s,1)),e.getStyle().minWidth="6.6rem",e.getChilStyleByQuery("input[type=number]").minWidth="5.5rem",e.getChilStyleByQuery("input[type=number]").width="5.5rem",e.addChangeListener(e=>this.setDimensions());let n=new GridBagConstraints;n.gridx=a,n.gridy=i,n.anchor=GridBagConstraints.WEST,n.insets=new Insets(0,5,0,5),this.add(e,n)}addDimension(e,t){let s=new GridBagConstraints;s.gridy=t,s.gridwidth=3,s.fill=GridBagConstraints.HORIZONTAL,s.insets=new Insets(2,5,0,0),this.add(e,s)}setDimensions(){let e=this.width.getValue(),t=this.height.getValue(),s=this.resolution.getValue(),a=e/s,i=t/s;this.dimensionMM.setText(new Number(25.4*a).toFixed(2)+" ✖ "+new Number(25.4*i).toFixed(2)+" mm"),this.dimensionIN.setText(new Number(a).toFixed(2)+" ✖ "+new Number(i).toFixed(2)+" inch")}getSelectedSize(){return new Dimension(this.width.getValue(),this.height.getValue())}getSelectedColor(){return this.selectedColor}}class Z4StatusPanel extends JSPanel{projectName=new JSLabel;progressBar=new JSProgressBar;constructor(){super(),this.cssAddClass("z4statuspanel"),this.setLayout(new GridBagLayout),this.projectName.setText(Z4Translations.PROJECT_NAME+": "),this.setLabel(this.projectName,0),this.addPipe(1),this.progressBar.setStringPainted(!0);let e=new GridBagConstraints;e.gridx=2,e.gridy=0,e.weightx=1,e.fill=GridBagConstraints.HORIZONTAL,this.add(this.progressBar,e)}addPipe(e){let t=new JSLabel;t.setText(" | "),this.setLabel(t,e)}setLabel(e,t){let s=new GridBagConstraints;s.gridx=t,s.gridy=0,this.add(e,s)}setProjectName(e){this.projectName.setText(Z4Translations.PROJECT_NAME+": "+e)}setProgressBarValue(e){this.progressBar.setValue(e)}}class Z4Ribbon extends JSTabbedPane{filePanel=new Z4RibbonFilePanel;layerPanel=new Z4RibbonLayerPanel;settingsPanel=new Z4RibbonSettingsPanel;constructor(){super(),this.cssAddClass("z4ribbon"),this.addTab(Z4Translations.FILE,this.filePanel),this.addTab(Z4Translations.LAYER,this.layerPanel),this.addTab(Z4Translations.SETTINGS,this.settingsPanel)}setCanvas(e){this.filePanel.setCanvas(e),this.layerPanel.setCanvas(e)}setStatusPanel(e){this.filePanel.setStatusPanel(e)}}class Z4Canvas extends JSComponent{canvas=document.createElement("canvas");ctx=this.canvas.getContext("2d");chessboard=null;resizeObserver=new ResizeObserver(()=>this.drawCanvas());projectName=null;saved=!0;paper=new Z4Paper;constructor(){super(document.createElement("div")),this.cssAddClass("z4canvas"),this.resizeObserver.observe(this.canvas),this.canvas.width=Z4Constants.DEFAULT_IMAGE_SIZE,this.canvas.height=Z4Constants.DEFAULT_IMAGE_SIZE,this.appendNodeChild(this.canvas),this.addLayer(Z4Constants.DEFAULT_IMAGE_SIZE,Z4Constants.DEFAULT_IMAGE_SIZE,new Color(0,0,0,0)),this.saved=!0;let e=document.createElement("img");e.onload=t=>(this.chessboard=this.ctx.createPattern(e,"repeat"),this.drawCanvas(),null),e.src="image/chessboard.png"}create(e,t,s,a){this.paper.reset(),this.paper.addLayer(e,t,s,e,t),this.afterCreate("",e,t,a),this.drawCanvas()}createFromFile(e,t){let s=new FileReader;s.onload=a=>this.createFromURL(e.name.substring(0,e.name.lastIndexOf(".")),s.result,t),s.readAsDataURL(e)}createFromClipboard(e){navigator.clipboard.read().then(t=>{t.forEach(t=>{let s=t.types.find((e,t,s)=>e.startsWith("image/"));t.getType(s).then(t=>{this.createFromURL("",URL.createObjectURL(t),e)})})})}createFromURL(e,t,s){let a=document.createElement("img");return a.onload=t=>(this.paper.reset(),this.paper.addLayerFromImage(a,a.width,a.height),this.afterCreate(e,a.width,a.height,s),this.drawCanvas(),null),a.src=t,null}afterCreate(e,t,s,a){this.projectName=e,a.setProjectName(e),this.saved=!0,this.canvas.width=t,this.canvas.height=s}openProject(e,t){new JSZip().loadAsync(e).then(e=>{e.file("manifest.json").async("string",null).then(s=>{this.paper.reset();let a=JSON.parse(""+s);this.openLayer(e,a,a.layers,0,t)})})}openLayer(e,t,s,a,i){e.file("layers/layer"+a+".png").async("blob",e=>i.setProgressBarValue(e.percent)).then(n=>{let r=document.createElement("img");i.setProgressBarValue(0),r.onload=n=>(this.paper.addLayerFromImage(r,r.width,r.height),this.paper.getLayerAt(a).move(s[a].offsetX,s[a].offsetY),a+1===s.length?(this.afterCreate(t.projectName,t.width,t.height,i),this.drawCanvas()):this.openLayer(e,t,s,a+1,i),null),r.src=URL.createObjectURL(n)})}saveProject(e,t,s){this.projectName=e,t.setProjectName(e),this.saveLayer(new JSZip,[],0,t,s)}saveLayer(e,t,s,a,i){let n=this.paper.getLayerAt(s);n.convertToBlob(r=>{let l=n.getOffset();if(t[s]='{"offsetX": '+l.x+',"offsetY": '+l.y+"}",e.file("layers/layer"+s+".png",r,null),s+1===this.paper.getLayersCount()){let o='{"projectName": "'+this.projectName+'",\n"width": '+this.canvas.width+',\n"height": '+this.canvas.height+',\n"layers": ['+t.join(",")+"]}";e.file("manifest.json",o,null);let d={};d.type="blob",d.compression="DEFLATE",d.streamFiles=!0;let h={};h.level=9,d.compressionOptions=h,e.generateAsync(d,e=>a.setProgressBarValue(e.percent)).then(e=>{saveAs(e,this.projectName+".z4i"),a.setProgressBarValue(0),this.saved=!0,i&&i()})}else this.saveLayer(e,t,s+1,a,i)})}exportToFile(e,t,s){let a=new OffscreenCanvas(this.canvas.width,this.canvas.height),i=a.getContext("2d");this.paper.draw(i);let n={};n.type=".png"===t?"image/png":"image/jpeg",n.quality=s,a.convertToBlob(n).then(s=>{let a=document.createElement("a");a.setAttribute("href",URL.createObjectURL(s)),a.setAttribute("download",e+t),document.body.appendChild(a);let i=document.createEvent("MouseEvents");i.initEvent("click",!1,!1),a.dispatchEvent(i),document.body.removeChild(a)})}addLayer(e,t,s){this.paper.addLayer(e,t,s,this.canvas.width,this.canvas.height),this.afterAddLayer(),this.drawCanvas()}addLayerFromFile(e){let t=new FileReader;t.onload=e=>this.addLayerFromURL(t.result),t.readAsDataURL(e)}addLayerFromClipboard(){navigator.clipboard.read().then(e=>{e.forEach(e=>{let t=e.types.find((e,t,s)=>e.startsWith("image/"));e.getType(t).then(e=>{this.addLayerFromURL(URL.createObjectURL(e))})})})}addLayerFromURL(e){let t=document.createElement("img");return t.onload=e=>(this.paper.addLayerFromImage(t,this.canvas.width,this.canvas.height),this.afterAddLayer(),this.drawCanvas(),null),t.src=e,null}afterAddLayer(){let e=this.paper.getSize(),t=(e.width-this.canvas.width)/2,s=(e.height-this.canvas.height)/2;this.paper.shift(t,s),this.saved=!1,this.canvas.width=e.width,this.canvas.height=e.height}getProjectName(){return this.projectName}isSaved(){return this.saved}drawCanvas(){this.ctx.save(),this.ctx.fillStyle=this.chessboard,this.ctx.fillRect(0,0,this.canvas.width,this.canvas.height),this.ctx.restore(),this.paper.draw(this.ctx)}}class Z4Translations{static CURRENT_LANGUAGE=null;static FILE="";static NEW_PROJECT="";static CREATE="";static FROM_CLIPBOARD="";static FROM_FILE="";static OPEN="";static OPEN_PROJECT="";static SAVE="";static SAVE_PROJECT="";static EXPORT="";static PROJECT_NOT_SAVED_MESSAGE="";static LAYER="";static NEW_LAYER="";static SETTINGS="";static LANGUAGE="";static LANGUAGE_ENGLISH_NATIVE="";static LANGUAGE_ITALIAN_NATIVE="";static THEME="";static THEME_AUTO="";static THEME_LIGHT="";static THEME_DARK="";static THEME_COLOR="";static REFRESH_PAGE_MESSAGE="";static PROJECT_NAME="";static FILENAME="";static QUALITY="";static RESET="";static WIDTH="";static HEIGHT="";static RESOLUTION="";static FILLING_COLOR="";static EDIT="";static{switch(navigator.language.substring(0,2)){case"en":default:Z4Translations.setEnglish();break;case"it":Z4Translations.setItalian()}}constructor(){}static setEnglish(){Z4Translations.FILE="File",Z4Translations.NEW_PROJECT="New Project",Z4Translations.CREATE="Create",Z4Translations.FROM_CLIPBOARD="From Clipboard",Z4Translations.FROM_FILE="From File",Z4Translations.OPEN="Open",Z4Translations.OPEN_PROJECT="Open Project",Z4Translations.SAVE="Save",Z4Translations.SAVE_PROJECT="Save Project",Z4Translations.EXPORT="Export",Z4Translations.PROJECT_NOT_SAVED_MESSAGE="Project not saved, do you want to save your changes?",Z4Translations.LAYER="Layer",Z4Translations.NEW_LAYER="New Layer",Z4Translations.SETTINGS="Settings",Z4Translations.LANGUAGE="Language",Z4Translations.LANGUAGE_ENGLISH_NATIVE="English",Z4Translations.LANGUAGE_ITALIAN_NATIVE="Italiano",Z4Translations.THEME="Theme",Z4Translations.THEME_AUTO="Auto",Z4Translations.THEME_LIGHT="Light",Z4Translations.THEME_DARK="Dark",Z4Translations.THEME_COLOR="Color",Z4Translations.REFRESH_PAGE_MESSAGE="Refresh the page to make the changes",Z4Translations.PROJECT_NAME="Project Name",Z4Translations.FILENAME="File Name",Z4Translations.QUALITY="Quality",Z4Translations.RESET="Reset",Z4Translations.WIDTH="Width",Z4Translations.HEIGHT="Height",Z4Translations.RESOLUTION="Resolution",Z4Translations.FILLING_COLOR="Filling Color",Z4Translations.EDIT="Edit",Z4Translations.CURRENT_LANGUAGE=new KeyValue("en",Z4Translations.LANGUAGE_ENGLISH_NATIVE)}static setItalian(){Z4Translations.FILE="File",Z4Translations.NEW_PROJECT="Nuovo Progetto",Z4Translations.CREATE="Crea",Z4Translations.FROM_CLIPBOARD="Dagli Appunti",Z4Translations.FROM_FILE="Da File",Z4Translations.OPEN="Apri",Z4Translations.OPEN_PROJECT="Apri Progetto",Z4Translations.SAVE="Salva",Z4Translations.SAVE_PROJECT="Salva Progetto",Z4Translations.EXPORT="Esporta",Z4Translations.LAYER="Livello",Z4Translations.NEW_LAYER="Nuovo Livello",Z4Translations.PROJECT_NOT_SAVED_MESSAGE="Progetto non salvato, vuoi salvare le modifiche?",Z4Translations.SETTINGS="Impostazioni",Z4Translations.LANGUAGE="Lingua",Z4Translations.LANGUAGE_ENGLISH_NATIVE="English",Z4Translations.LANGUAGE_ITALIAN_NATIVE="Italiano",Z4Translations.THEME="Tema",Z4Translations.THEME_AUTO="Auto",Z4Translations.THEME_LIGHT="Chiaro",Z4Translations.THEME_DARK="Scuro",Z4Translations.THEME_COLOR="Colore",Z4Translations.REFRESH_PAGE_MESSAGE="Aggiorna la pagina per eseguire le modifiche",Z4Translations.PROJECT_NAME="Nome Progetto",Z4Translations.FILENAME="Nome File",Z4Translations.QUALITY="Qualit\xe0",Z4Translations.RESET="Ripristina",Z4Translations.WIDTH="Larghezza",Z4Translations.HEIGHT="Altezza",Z4Translations.RESOLUTION="Risoluzione",Z4Translations.FILLING_COLOR="Colore di Riempimento",Z4Translations.EDIT="Modifica",Z4Translations.CURRENT_LANGUAGE=new KeyValue("it",Z4Translations.LANGUAGE_ITALIAN_NATIVE)}}class Z4Constants{static ACCEPTED_IMAGE_FILE_FORMAT=[".gif",".png",".jpeg",".jpg"];static DEFAULT_IMAGE_SIZE=500;static MAX_IMAGE_SIZE=3e3;static DEFAULT_DPI=150;static MAX_DPI=1500;constructor(){}}class Z4Layer{offscreen=null;offscreenCtx=null;offsetX=0;offsetY=0;width=0;height=0;constructor(e,t,s,a,i){this.offscreen=new OffscreenCanvas(e,t),this.offscreenCtx=this.offscreen.getContext("2d"),this.offscreenCtx.fillStyle=this.getFillStyle(s.getRGBA_HEX()),this.offscreenCtx.fillRect(0,0,e,t),this.offsetX=(a-e)/2,this.offsetY=(i-t)/2,this.width=e,this.height=t}getFillStyle(e){return e}static fromImage(e,t,s){let a=new Z4Layer(e.width,e.height,new Color(0,0,0,0),t,s);return a.offscreenCtx.drawImage(e,0,0),a}convertToBlob(e){let t={};t.type="image/png",this.offscreen.convertToBlob(t).then(t=>{e(t)})}shift(e,t){this.offsetX+=e,this.offsetY+=t}move(e,t){this.offsetX=e,this.offsetY=t}getOffset(){return new Point(this.offsetX,this.offsetY)}getSize(){return new Dimension(this.width,this.height)}draw(e){e.drawImage(this.offscreen,this.offsetX,this.offsetY)}}class Z4Paper{layers=[];getLayersCount(){return this.layers.length}getLayerAt(e){return this.layers[e]}addLayer(e,t,s,a,i){this.layers.push(new Z4Layer(e,t,s,a,i))}addLayerFromImage(e,t,s){this.layers.push(Z4Layer.fromImage(e,t,s))}reset(){this.layers.length=0}shift(e,t){this.layers.forEach(s=>s.shift(e,t))}getSize(){return this.layers.map(e=>e.getSize()).reduce((e,t,s,a)=>e?new Dimension(Math.max(e.width,t.width),Math.max(e.height,t.height)):t)}draw(e){this.layers.forEach(t=>t.draw(e))}}